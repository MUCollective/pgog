---
title: "Reproducing existing uncertainty visualizations with existing stats and geoms"
author: "Xiaoying Pu"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Reproducing existing uncertainty visualizations with existing stats and geoms}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(devtools)
library(riskyr)
library(rv2)
library(tidyverse)
library(ggplot2)
library(ggridges)
library(scales)
# library(productplots)
library(ggmosaic)
library(ggwaffle)
```

# TODO: examples from the four papers

# riskyr

- Icon array, 
- Problems with `plot_icons`
  - Not `ggplot`: _ad hoc_, etc.

## Icon array

TODO: do we have specs for icon array? This spec is not very accurate

```{gog}
P(has_cancer) -> shape
P(test_positive) -> color
100 -> sample_size 
```


.... or ggplot-like specs


TODO: difficult to express joint distribution here...

```{gog}
ggplot(cancer, aes(x = ???)) + 
  geom_dotplot(
    binwidth= foo(sample_size), 
    shape = P(has_cancer),
    color = P(test_positive),
    stackdir = "icon_array",
  )
```


```{r,fig.width=6, fig.height=3, echo=FALSE}
plot_icons(prev = .1, sens = .70, spec =   NA, fart = .090, N = 100,
           icon.types = c(21, 21, 22, 22),
           title.lbl = "Mammography screening")
```

-----

# Icon array with ggplot?

## waffles

"Because of the inner mechanisms of ggplot2, some of the necessary data transformations have to be completed outside of a standard plot creation"


```{r}
iris$Species <- as.character(iris$Species)
waffle_data <- waffle_iron(iris, aes_d(group = Species))

ggplot(waffle_data, aes(x, y, fill = group)) + 
  geom_waffle() + 
  coord_equal() + 
  scale_fill_waffle() + 
  theme_waffle()
```






## Product plot?

- TODO: look at product plot?
- How to specify the coloring?

```{gog}
has_cancer -> width
test_positive -> height
```


```{r, echo=FALSE}
plot_mosaic(prev = .1, sens = .70, spec =   NA, fart = .090, N = 100,
            title.lbl = "Mammography screening")
```


# ggridges

https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html

## "Bar chart"

```{gog}
cancer -> x
test -> y
P(.) -> width
```



```{r, echo=FALSE}
fake_df <- data.frame(test=c(0, 0, 0.1, 0.1, 0.1, 0.2, 0.2, 0.8, 0.8, 0.9, 0.9, 0.9, 1, 1),
                      cancer = c(rep(0, 7), rep(1, 7)),
                      height= c(0, (80-8)/80, (80-8)/80, 0, 8/80, 8/80, 0,   0, 0.7, 0.7,0, 0.3, 0.3, 0))
ggplot(fake_df, 
       aes(test, cancer, height = height, group = cancer)) + 
  geom_ridgeline(fill = "lightblue") + 
  theme(
    # axis.title.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + 
   scale_y_continuous(breaks=pretty_breaks(2)) +
  coord_flip() +
  NULL
```


# quantile-dotplots
https://github.com/mjskay/when-ish-is-my-bus/blob/master/quantile-dotplots.md

```{r, echo=FALSE}
mu_a = log(11.4)
mu_b = log(7)
sigma = 0.2
samples = 20

quantiles = data_frame(
    p_less_than_x = rep(seq(from = 1/samples / 2, to = 1 - (1/samples / 2), length=samples), 2),
    x = c(qlnorm(p_less_than_x[1:samples], mu_a, sigma), qlnorm(p_less_than_x[(samples + 1):(samples * 2)], mu_b, sigma)),
    condition = c(rep("A", samples), rep("B", samples))
)
```


_GoG specs_

```{GoG}
value -> x
condition -> y
P(.) -> height
```


```{r, echo=FALSE}
quantiles %>%
  ggplot(aes(x = x)) +
  geom_dotplot(binwidth = 1.25, color=NA) +
  xlim(-3.5,30) +
  facet_grid(condition ~ .) +
  NULL
```


# Product plots

```{r}
data(happy)
```

Examples from the paper

```{r}
# prodplot(happy, ~ happy + finrela + health, c("vspine", "fluct"))
# prodplot(happy, ~ happy | finrela + health, c("hspine", "fluct"))
```

- Code does not reproduce anymore!
  - horizont vertical flipped
  - pretty color scheme gone


```{r}
prodplot(happy,~ ~ marital+sex + happy, c("fluct", "hspine"))
prodplot(happy, ~ marital+sex + happy, c("vspine", "hspine", "hbar"))
prodplot(happy, ~~ marital+sex + happy, c("vspine", "hspine", "hspine"))
```


## Figure 6


```{r}
prodplot(happy, ~ happy + marital + sex + degree, c("vspine", "hbar", "hspine", "hbar"))
```


## Figure 7 in prod plot paper

```{r}
prodplot(happy, ~ sex + happy, c("vspine", "hbar"),na.rm = TRUE)
prodplot(happy, ~ age + marital, c("hbar", "vspine"))
```


## Figure 8; conditioning

```{r}
prodplot(happy, ~ happy + health + finrela, c("vspine","fluct"))
prodplot(happy, ~ happy | health + finrela, c("vspine", "fluct"))
```


## P(A) P(B|A) v.s. P(B) P(A|B)

```{r}
prodplot(happy, ~ degree + sex, c("vspine", "hbar")) # hbar = P(sex) * vspine = P(degree | sex)
prodplot(happy, ~ sex + degree, c("hbar", "vspine")) # vspine = P(degree) * hbar = P(sex | degree)
prodplot(happy, ~ degree + sex, c("hbar", "vspine"))
prodplot(happy, ~ sex + degree, c("vspine", "hbar"))
```


## conditinoals

```{r}
prodplot(happy, ~ happy+degree|health+sex, divider = c("hspine", "vspine", "fluct"))
```

## Tree maps

```{r}
prodplot(happy, ~ happy + degree, divider = c("tile", "hbar"))
```


# ggmsaic

Using mapping: 

- x <- product()
- conds <- product()

## 1 ~ X

```{r}
ggplot(happy) +
  geom_mosaic(aes(x = product(marital), fill = happy), na.rm = TRUE) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
```

## 1 ~ Y + X

```{r}

ggplot(data = happy) +
  geom_mosaic(
    aes(x = product(marital, happy), 
        fill=marital), na.rm=TRUE)
```


## 1 ~ X | Z

Two similar-looking vizes

is this confusion a consequence of not placing probs as first-class citizens?



- This version will not work for icon arrays?
- What does conditioning mean for a visualization
- Should only display P( happy | sex = female)?
- Why is the happy variable on the y axis??

```{r}

```

```{r}

# or change "health" to "sex"

ggplot(data = happy) +
  geom_mosaic(
    aes(x = product(happy), 
        fill=sex),
    na.rm=TRUE
  ) 

```


This version is more intuitive but it's not using the `conds` argument

```{r}

# maybeb this is wrong
ggplot(data = happy) +
  geom_mosaic(
    aes(x = product(happy, sex), 
        fill=happy
    ),
    divider = c("vbar", "hspine"),
    na.rm=TRUE
  ) 


# what's wrong with this one?

ggplot(happy) + 
  geom_mosaic(aes(x = product(happy), conds = product(sex), fill =happy),
              divider = c("vspine", "hbar"),
              na.rm = TRUE)
```

## 1 ~ X + Y | Z


```{r}
ggplot(data=happy) + 
  geom_mosaic(aes(x = product(happy, sex), 
                  fill = happy, 
                  conds = product(finrela)),
              na.rm = TRUE, divider = c("vspine", "vspine", "hbar"))
```

## X + Y + Z: 3 ways of factoring

### f(x,y|z) * f(z)
```{r}
ggplot(happy) + 
  geom_mosaic(aes(
    x = product(marital, sex, happy),
    fill = marital,
  ), divider = c("fluct", "vbar"),
  na.rm = TRUE)
```


### f(x|y,z) * f(y,z)

```{r}
ggplot(happy) + 
  geom_mosaic(aes(
    x = product(marital, sex, happy),
    fill = happy,
  ), divider = c("vbar", "fluct"),
  na.rm = TRUE)
```


## Details about fill aes

```{r}
ggplot(happy) + 
  geom_mosaic(aes(x = product(finrela, happy), fill = finrela), 
              divider = c("vspine", "hbar"),
              na.rm = TRUE)
```



## Conditionals 

```{r}
ggplot(happy) +
  geom_mosaic(aes(x = product(happy), fill=happy, conds = product(sex,degree)), divider = c("vspine", "hbar", "hspine"))
```

```{r}
ggplot(happy) +
  geom_mosaic(aes(x = product(happy), 
                  fill = happy,
                  conds = product(sex, degree)), 
              divider = c("vspine", "hbar", "hspine")) # changing the last two aes don't seem to matter

# ggplot(happy) +
#   geom_mosaic(aes(x = product(happy), 
#                   fill = happy,
#                   conds = product(sex, degree)), 
#               divider = c("vspine", "hspine", "hbar"))
# 
# 
# ggplot(happy) +
#   geom_mosaic(aes(x = product(happy), 
#                   fill = happy,
#                   conds = product(sex, degree)), 
#               divider = c("vspine", "hspine", "hspine"))


ggplot(happy) +
  geom_mosaic(aes(x = product(happy), 
                  fill = happy,
                  conds = product(sex, degree)), 
              divider = c("vspine", "vbar", "hbar"))


ggplot(happy) +
  geom_mosaic(aes(x = product(happy), 
                  fill = happy,
                  conds = product(sex, degree, finrela)), 
              divider = c("vspine", "fluct", "hbar"))
```

### P(A,B|C,D)
`prodplot(happy, ~ happy+degree|health+sex, divider = c("hspine", "vspine", "fluct"))`

```{r}
ggplot(happy) + 
  geom_mosaic(aes(x = product(happy, degree), 
              fill = degree,
              conds = product(health, sex)),
              na.rm = TRUE, 
              divider = c("fluct", "hspine", "vspine"))

```


### P(B) P(1|A)???


```{r}
ggplot(happy) +
  geom_mosaic(aes(x=product(happy), conds = product(happy)), divider = c("vbar", "hspine"))
```


```{r}
ggplot(happy) +
  geom_mosaic(aes(x = product(happy),
                   fill = happy,
                   conds = product(sex)),
               divider = c("hbar", "vspine"),
              na.rm = TRUE)
```

```{r}
ggplot(happy) +
  geom_mosaic(aes(x = product(happy),
                   fill = happy,
                   conds = product(sex)),
               divider = c("hbar", "vspine"),
              na.rm = TRUE)
```

```{r}
ggplot(happy) +
  geom_mosaic(aes(x = product(sex),
                   fill = sex,
                   conds = product(happy)),
               divider = c("vspine", "hbar"),
              na.rm = TRUE)
```


```{r}
ggplot(happy) + 
  geom_mosaic(aes(x = product(happy), 
                  fill = happy,
                  conds = product(happy)),
              divider = c("hbar", "hspine"),
              na.rm = TRUE)
```


###? 
```{r}

ggplot(data=happy) + 
  geom_mosaic(aes(x = product(happy), fill = happy,
                  conds = product(sex, polviews, degree)),
              na.rm = TRUE)
```

```{r}

ggplot(data=happy) + 
  geom_mosaic(aes(x = product(polviews, sex), fill = polviews),
              na.rm = TRUE, divider = c("hbar", "vspine"))
```


```{r}
ggplot(happy) + 
  geom_mosaic(aes(x = product(happy, marital, sex), fill = happy), divider = c("hbar", "fluct"), na.rm = TRUE)  +
  coord_fixed()
```

```{r}
ggplot(happy) + 
  geom_mosaic(aes(x = product(happy, marital, sex), fill = happy), divider = c("hbar", "vspine", "hspine"), na.rm = TRUE)  +
  coord_fixed()
```


## Nested bars

Joint v.s. conditional 

```{r}
happy %>%
  ggplot() + 
  geom_mosaic(aes(x = product(happy), conds = product(sex)), divider = c("hbar", "hbar"))

happy %>%
  ggplot() + 
  geom_mosaic(aes(x = product(happy, sex)), divider = c("hbar", "hbar"))
```

## faceting?

```{r}
happy %>%
  ggplot() + 
  geom_mosaic(aes(x = product(happy)), na.rm = TRUE) + 
  facet_wrap(. ~ sex + finrela)
  
```

```{r}
prodplot(happy, ~ happy|sex+finrela, divider = c("vbar", "fluct"))
```




# Dotplots

Try it on the cancer dataset


```{r}
cancer %>%
  ggplot(aes(x = test)) +
  geom_dotplot(binwidth = 1) + 
  xlim(-50, 50)
```


# Density
```{r}
mtcars <- head(mtcars, n = 10)
```

```{r}
ggplot(mapping = aes(x = mpg)) + 
  geom_density(data = filter(mtcars, cyl == 6))  + 
  geom_density(data = filter(mtcars, cyl == 4)) + 
  geom_density(data = filter(mtcars, cyl == 8))

# count = density * n
```

```{r}

ggplot(mapping = aes(x = mpg, y = stat(count))) + 
  geom_density(data = filter(mtcars, cyl == 6))  + 
  geom_density(data = filter(mtcars, cyl == 4)) + 
  geom_density(data = filter(mtcars, cyl == 8))


ggplot(mtcars, mapping = aes(x = mpg, fill = factor(cyl), alpha = 0.4)) + 
  geom_histogram(binwidth = 1, position = "identity")
  
  
```

```{r}
ggplot(mtcars, aes(x = mpg)) + geom_density(adjust = 1/2)
```


```{r}

ggplot(mtcars, aes(x = cyl)) + 
  geom_density(position = "stack")

ggplot(mtcars, aes(x = mpg, fill = factor(cyl))) + 
  geom_density(position = "stack")

ggplot(mtcars, aes(x = mpg, fill = factor(cyl))) + 
  geom_density() + facet_grid(cyl~ .)

# count = density * n
# the one with correct marginal distribution

ggplot(mtcars, aes(x = hp, y = stat(density * n), fill = factor(cyl))) + 
  geom_density(position = "stack")

# conditional
ggplot(mtcars, aes(x = mpg, y = stat(density * n), fill = factor(cyl))) + 
  geom_density(position = "fill")
```
